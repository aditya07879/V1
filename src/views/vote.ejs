<%- include('partials/head', { title: election.title + ' | Vote' }) %>
<%- include('partials/nav') %>

<main class="min-h-screen bg-bg py-20">
  <div class="max-w-4xl mx-auto px-6">

    <!-- ================= ELECTION HEADER ================= -->
    <section class="mb-16">
      <h1 class="text-white text-4xl font-semibold mb-3">
        <%= election.title %>
      </h1>
      <p class="text-muted max-w-2xl">
        <%= election.description %>
      </p>

      <span
        class="inline-block mt-4 text-xs px-3 py-1 rounded-full
               bg-accent/20 text-accent">
        Official Election â€¢ Voting Open
      </span>
    </section>

    <!-- ================= VOTER KEY ================= -->
    <section class="bg-card rounded-2xl p-6 mb-20 shadow-lg shadow-black/40">
  <h2 class="text-white font-medium mb-2">
    Voter Access Key
  </h2>

  <p class="text-muted text-sm mb-4">
    Enter the voter key to unlock this election.
  </p>

  <!-- Input + Button -->
  <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">

    <input
      id="voterKey"
      type="text"
      placeholder="Enter voter key"
      class="w-full sm:flex-1 bg-bg border border-white/10 rounded-md
             px-4 py-3 text-white
             focus:ring-2 focus:ring-accent/40
             focus:outline-none"
    />

    <button
      id="verifyKey"
      class="w-full sm:w-auto bg-accent px-6 py-3 rounded-md
             text-white font-medium
             hover:brightness-110
             active:scale-95 transition">
      Verify Key
    </button>
  </div>

  <!-- Error Message -->
  <p
    id="keyError"
    class="mt-3 text-red-400 text-sm
           hidden
           flex items-center gap-2
           animate-error">
    <!-- Warning Icon -->
    <svg xmlns="http://www.w3.org/2000/svg"
         class="w-4 h-4 flex-shrink-0"
         fill="none"
         viewBox="0 0 24 24"
         stroke="currentColor">
      <path stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 9v2m0 4h.01M5.07 19h13.86c1.54 0 2.5-1.67 1.73-3L13.73 4c-.77-1.33-2.69-1.33-3.46 0L3.34 16c-.77 1.33.19 3 1.73 3z"/>
    </svg>

    <span>Invalid election key</span>
  </p>
</section>

<!-- Animation Styles -->
<style>
@keyframes errorSlide {
  0% {
    opacity: 0;
    transform: translateY(-4px);
  }
  60% {
    opacity: 1;
    transform: translateY(2px);
  }
  100% {
    transform: translateY(0);
  }
}

@keyframes errorShake {
  0% { transform: translateX(0); }
  25% { transform: translateX(-4px); }
  50% { transform: translateX(4px); }
  75% { transform: translateX(-2px); }
  100% { transform: translateX(0); }
}

.animate-error {
  animation: errorSlide 0.3s ease-out,
             errorShake 0.4s ease-in-out;
}
</style>


    <!-- ================= CANDIDATES ================= -->
    <section id="candidatesSection"
             class="opacity-40 pointer-events-none transition">

      <h2 class="text-white text-2xl font-semibold mb-8">
        Select a Candidate
      </h2>

      <form id="voteForm">
        <div class="grid sm:grid-cols-2 md:grid-cols-3 gap-6 mb-12">

          <% candidates.forEach(candidate => { %>
            <label
              class="relative bg-card rounded-2xl p-6 cursor-pointer
                     border-2 border-transparent
                     hover:border-accent/50 transition
                     has-[:checked]:border-accent
                     has-[:checked]:bg-accent/10">

              <!-- RADIO -->
              <input
                type="radio"
                name="candidateId"
                value="<%= candidate._id %>"
                class="absolute top-4 right-4 scale-125 accent-accent"
                required
              />

              <!-- IMAGE -->
              <% if (candidate.photo) { %>
                <img
                  src="<%= candidate.photo %>"
                  alt="<%= candidate.name %>"
                  class="w-24 h-24 rounded-full mx-auto mb-4
                         object-cover border border-white/10"
                />
              <% } else { %>
                <div
                  class="w-24 h-24 rounded-full mx-auto mb-4
                         bg-bg flex items-center justify-center
                         text-muted text-sm">
                  No Image
                </div>
              <% } %>

              <!-- NAME -->
              <p class="text-white font-medium text-center">
                <%= candidate.name %>
              </p>
            </label>
          <% }) %>

        </div>

        <button
          id="submitVote"
          disabled
          class="bg-accent/40 cursor-not-allowed
                 px-8 py-4 rounded-lg
                 text-white font-medium transition">
          Submit Vote
        </button>

        <p class="text-muted text-sm mt-3">
          Your vote cannot be changed once submitted.
        </p>

        <p id="voteError"
           class="text-red-400 text-sm mt-3 hidden"></p>
      </form>

    </section>

  </div>
</main>

<script>
  const verifyBtn = document.getElementById("verifyKey");
  const voterKeyInput = document.getElementById("voterKey");
  const candidatesSection = document.getElementById("candidatesSection");
  const submitBtn = document.getElementById("submitVote");
  const keyError = document.getElementById("keyError");
  const voteError = document.getElementById("voteError");

  let verifiedKey = null;

  verifyBtn.onclick = async () => {
    keyError.classList.add("hidden");

    const res = await fetch("/api/votes/verify-key", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        electionId: "<%= election._id %>",
        voterKey: voterKeyInput.value.trim()
      })
    });

    if (!res.ok) {
      keyError.classList.remove("hidden");
      return;
    }

    verifiedKey = voterKeyInput.value.trim();
    candidatesSection.classList.remove("opacity-40", "pointer-events-none");

    submitBtn.disabled = false;
    submitBtn.classList.remove("bg-accent/40", "cursor-not-allowed");
    submitBtn.classList.add("bg-accent");
  };

  submitBtn.onclick = async (e) => {
    e.preventDefault();

    const selected = document.querySelector(
      "input[name='candidateId']:checked"
    );

    if (!selected) return;

    const res = await fetch("/api/votes/cast", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        electionId: "<%= election._id %>",
        candidateId: selected.value,
        voterKey: verifiedKey
      })
    });

    if (!res.ok) {
      voteError.textContent =
        "You have already voted or an error occurred.";
      voteError.classList.remove("hidden");
      return;
    }

    window.location.href = "/vote/success";
  };
</script>

<%- include('partials/footer') %>
